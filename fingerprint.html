<!DOCTYPE html>
<html>
<head>
  <title>Fingerprint Verification</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h3>Fingerprint Verification</h3>
      </div>
      <div class="card-body">
        <p>Upload your fingerprint scan for two-step verification:</p>
        <input type="file" id="finger-upload" accept="image/*" class="form-control" />
        <div id="upload-status" class="mt-3"></div>
        <div id="debug-info" class="mt-3 p-3 bg-light border rounded">
          <h5>Debug Information</h5>
          <div id="debug-content"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Environment variables -->
  <script src="env-vars.js"></script>
  <script src="env.js"></script>
  <!-- Firebase SDKs -->
  <script src="config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

    // Debug function to log and display information
    function debugLog(message, data = null) {
      console.log(message, data);
      const debugContent = document.getElementById("debug-content");
      const timestamp = new Date().toLocaleTimeString();
      
      let displayMessage = `<div class="mb-2"><strong>${timestamp}:</strong> ${message}`;
      if (data) {
        displayMessage += `<pre class="mt-1 p-2 bg-white border rounded">${JSON.stringify(data, null, 2)}</pre>`;
      }
      displayMessage += '</div>';
      
      debugContent.innerHTML = displayMessage + debugContent.innerHTML;
    }

    // Check if we're in a production environment (Netlify)
    let firebaseConfig;
    
    // Try to get config from environment variables first (for Netlify)
    if (window.location.hostname.includes('netlify.app')) {
      console.log("Running on Netlify, checking for environment variables");
      firebaseConfig = {
        apiKey: process.env.FIREBASE_API_KEY || "AIzaSyDuKns6v5EOUDL-aZXMA2i6223aquQzo1E",
        authDomain: process.env.FIREBASE_AUTH_DOMAIN || "voter-card-scanner.firebaseapp.com",
        projectId: process.env.FIREBASE_PROJECT_ID || "voter-card-scanner",
        storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "voter-card-scanner.appspot.com",
        messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "665299220821",
        appId: process.env.FIREBASE_APP_ID || "1:665299220821:web:f8025478a24f5375c697dc",
        measurementId: process.env.FIREBASE_MEASUREMENT_ID || "G-G88F77H8VR",
        databaseURL: "https://voter-card-scanner-default-rtdb.asia-southeast1.firebasedatabase.app"
      };
    } else {
      // Use the config.js file for local development
      firebaseConfig = config.firebaseConfig;
      // Ensure databaseURL is set
      if (!firebaseConfig.databaseURL) {
        firebaseConfig.databaseURL = "https://voter-card-scanner-default-rtdb.asia-southeast1.firebasedatabase.app";
      }
    }

    debugLog("Firebase config loaded", firebaseConfig);

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    // Check if voter ID exists in localStorage
    const voterId = localStorage.getItem("voter_id");
    debugLog("Voter ID from localStorage", voterId);

    document.getElementById("finger-upload").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) {
        debugLog("No file selected");
        return;
      }

      debugLog("File selected", { name: file.name, size: file.size, type: file.type });

      // Retrieve the voter ID
      const voterId = localStorage.getItem("voter_id");
      if (!voterId) {
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">Error: Voter ID not found. Please login first.</div>
        `;
        debugLog("Error: Voter ID not found in localStorage");
        return;
      }

      try {
        // Compute SHA-256 hash of the file
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashHex = Array.from(new Uint8Array(hashBuffer))
                          .map(b => b.toString(16).padStart(2, '0'))
                          .join('');
        
        debugLog("Generated Hash", hashHex);

        // Get the stored hash from Firestore
        debugLog("Fetching voter details from Firestore", { voterId });
        const voterDoc = await getDoc(doc(db, "Voter detials", voterId));
        
        if (!voterDoc.exists()) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">Error: Voter record not found in database.</div>
          `;
          debugLog("Error: Voter record not found in Firestore", { voterId });
          return;
        }

        const voterData = voterDoc.data();
        debugLog("Voter data from Firestore", voterData);
        
        const storedHash = voterData.hash;
        
        debugLog("Stored Hash from Firestore", storedHash);
        
        if (!storedHash) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">
              <strong>Error!</strong> No fingerprint record found. Please register your fingerprint first.<br>
              <button onclick="window.location.href='index.html'" class="btn btn-primary mt-3">Go Back</button>
            </div>
          `;
          debugLog("Error: No fingerprint hash found in voter record");
          return;
        }

        // Compare the hashes
        if (hashHex === storedHash) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-success">
              <strong>Verification Successful!</strong><br>
              Fingerprint matches the stored record.<br>
              <div class="mt-2">
                <strong>Debug Information:</strong><br>
                Generated Hash: <code>${hashHex}</code><br>
                Stored Hash: <code>${storedHash}</code><br>
                Status: Hashes match
              </div>
              <button id="assignStationBtn" class="btn btn-primary mt-3">Assign to Station</button>
            </div>
          `;
          // Store verification status in localStorage
          localStorage.setItem("fingerprint_verified", "true");
          debugLog("Fingerprint verification successful");

          
          // Add click handler for the Assign Station button
          document.getElementById("assignStationBtn").addEventListener("click", async () => {
            try {
              debugLog("Assign Station button clicked");
              
              // Get all stations from Realtime Database
              debugLog("Fetching stations from Realtime Database");
              const stationsRef = ref(rtdb, "stations");
              const stationsSnapshot = await get(stationsRef);
              
              if (!stationsSnapshot.exists()) {
                debugLog("No stations found in database");
                document.getElementById("upload-status").innerHTML += `
                  <div class="alert alert-warning mt-3">
                    <strong>No Stations Found!</strong><br>
                    There are no voting stations in the database.<br>
                    Please contact an administrator.
                  </div>
                `;
                return;
              }
              
              const stationsData = stationsSnapshot.val();
              debugLog("Stations data from Realtime Database", stationsData);
              
              // Find active stations
              const activeStations = [];
              Object.entries(stationsData).forEach(([stationId, stationData]) => {
                debugLog(`Checking station ${stationId}`, stationData);
                if (stationData.session === "active") {
                  activeStations.push({
                    id: stationId,
                    lastActive: stationData.lastActive || 0
                  });
                }
              });
              
              debugLog("Active stations found", activeStations);
              
              // Sort active stations by lastActive (oldest first)
              activeStations.sort((a, b) => a.lastActive - b.lastActive);
              
              if (activeStations.length === 0) {
                debugLog("No active stations available");
                document.getElementById("upload-status").innerHTML += `
                  <div class="alert alert-warning mt-3">
                    <strong>No Active Stations!</strong><br>
                    There are no active voting stations available at the moment.<br>
                    Please try again later.
                  </div>
                `;
                return;
              }
              
              // Get the station with the oldest lastActive timestamp
              const selectedStation = activeStations[0];
              debugLog("Selected station for assignment", selectedStation);
              
              // Update the station with the voter ID and current timestamp
              const currentTime = Date.now();
              debugLog("Updating station in Realtime Database", {
                stationId: selectedStation.id,
                currentVoterId: voterId,
                lastActive: currentTime
              });
              
              await set(ref(rtdb, `stations/${selectedStation.id}`), {
                session: "active",
                lastActive: currentTime,
                currentVoterId: voterId
              });
              
              // Update voter's hasVoted status in Firestore
              debugLog("Updating voter status in Firestore", {
                voterId,
                hasVoted: true,
                assignedStation: selectedStation.id
              });
              
              await setDoc(doc(db, "Voter detials", voterId), {
                hasVoted: true,
                assignedStation: selectedStation.id
              }, { merge: true });
              
              document.getElementById("upload-status").innerHTML += `
                <div class="alert alert-success mt-3">
                  <strong>Station Assigned!</strong><br>
                  You have been assigned to <strong>${selectedStation.id}</strong>.<br>
                  Please proceed to that station to cast your vote.
                </div>
              `;
              debugLog("Station assignment completed successfully");
            } catch (error) {
              console.error('Error assigning station:', error);
              debugLog("Error assigning station", { error: error.message, stack: error.stack });
              document.getElementById("upload-status").innerHTML += `
                <div class="alert alert-danger mt-3">
                  <strong>Error!</strong> Failed to assign station. Please try again.<br>
                  <small>Technical details: ${error.message}</small>
                </div>
              `;
            }
          });
        } else {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">
              <strong>Verification Failed!</strong><br>
              Fingerprint does not match the stored record.<br>
              <div class="mt-2">
                <strong>Debug Information:</strong><br>
                Generated Hash: <code>${hashHex}</code><br>
                Stored Hash: <code>${storedHash}</code><br>
                Status: Hashes do not match
              </div>
            </div>
          `;
          localStorage.setItem("fingerprint_verified", "false");
          debugLog("Fingerprint verification failed - hashes do not match");
        }
      } catch (err) {
        console.error("Error:", err);
        debugLog("Error processing fingerprint", { error: err.message, stack: err.stack });
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">
            Error processing fingerprint. Please try again.<br>
            <small>Technical details: ${err.message}</small>
          </div>
        `;
      }
    });
  </script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
