<!DOCTYPE html>
<html>
<head>
  <title>Fingerprint Verification</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h3>Fingerprint Verification</h3>
      </div>
      <div class="card-body">
        <p>Upload your fingerprint scan for two-step verification:</p>
        <input type="file" id="finger-upload" accept="image/*" class="form-control" />
        <div id="upload-status" class="mt-3"></div>
      </div>
    </div>
  </div>
  <!-- Environment variables -->
  <script src="env-vars.js"></script>
  <script src="env.js"></script>
  <!-- Firebase SDKs -->
  <script src="config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

    // Check if we're in a production environment (Netlify)
    let firebaseConfig;
    
    // Try to get config from environment variables first (for Netlify)
    if (window.location.hostname.includes('netlify.app')) {
      console.log("Running on Netlify, checking for environment variables");
      firebaseConfig = {
        apiKey: process.env.FIREBASE_API_KEY || "AIzaSyDuKns6v5EOUDL-aZXMA2i6223aquQzo1E",
        authDomain: process.env.FIREBASE_AUTH_DOMAIN || "voter-card-scanner.firebaseapp.com",
        projectId: process.env.FIREBASE_PROJECT_ID || "voter-card-scanner",
        storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "voter-card-scanner.appspot.com",
        messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "665299220821",
        appId: process.env.FIREBASE_APP_ID || "1:665299220821:web:f8025478a24f5375c697dc",
        measurementId: process.env.FIREBASE_MEASUREMENT_ID || "G-G88F77H8VR"
      };
    } else {
      // Use the config.js file for local development
      firebaseConfig = config.firebaseConfig;
    }

    console.log("Firebase config loaded:", firebaseConfig);

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById("finger-upload").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // Retrieve the voter ID
      const voterId = localStorage.getItem("voter_id");
      if (!voterId) {
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">Error: Voter ID not found. Please login first.</div>
        `;
        return;
      }

      try {
        // Compute SHA-256 hash of the file
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashHex = Array.from(new Uint8Array(hashBuffer))
                          .map(b => b.toString(16).padStart(2, '0'))
                          .join('');
        
        // Debug: Log the hash to console
        console.log("Generated Hash:", hashHex);

        // Get the stored hash from Firestore
        const voterDoc = await getDoc(doc(db, "Voter detials", voterId));
        
        if (!voterDoc.exists()) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">Error: Voter record not found in database.</div>
          `;
          return;
        }

        const storedHash = voterDoc.data().hash;
        
        // Debug: Log the stored hash to console
        console.log("Stored Hash:", storedHash);
        
        if (!storedHash) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">
              <strong>Error!</strong> No fingerprint record found. Please register your fingerprint first.<br>
              <button onclick="window.location.href='index.html'" class="btn btn-primary mt-3">Go Back</button>
            </div>
          `;
          return;
        }

        // Compare the hashes
        if (hashHex === storedHash) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-success">
              <strong>Verification Successful!</strong><br>
              Fingerprint matches the stored record.<br>
              <div class="mt-2">
                <strong>Debug Information:</strong><br>
                Generated Hash: <code>${hashHex}</code><br>
                Stored Hash: <code>${storedHash}</code><br>
                Status: Hashes match
              </div>
              <button id="assignStationBtn" class="btn btn-primary mt-3">Assign to Station</button>
            </div>
          `;
          // Store verification status in localStorage
          localStorage.setItem("fingerprint_verified", "true");

          
          // Add click handler for the Assign Station button
          document.getElementById("assignStationBtn").addEventListener("click", async () => {
            try {
              // Get all stations from Firestore
              const stationsRef = collection(db, "stations");
              const stationsSnapshot = await getDocs(stationsRef);
              
              // Find active stations
              const activeStations = [];
              stationsSnapshot.forEach(doc => {
                const stationData = doc.data();
                if (stationData.session === "active") {
                  activeStations.push({
                    id: doc.id,
                    lastActive: stationData.lastActive || 0
                  });
                }
              });
              
              // Sort active stations by lastActive (oldest first)
              activeStations.sort((a, b) => a.lastActive - b.lastActive);
              
              if (activeStations.length === 0) {
                document.getElementById("upload-status").innerHTML += `
                  <div class="alert alert-warning mt-3">
                    <strong>No Active Stations!</strong><br>
                    There are no active voting stations available at the moment.<br>
                    Please try again later.
                  </div>
                `;
                return;
              }
              
              // Get the station with the oldest lastActive timestamp
              const selectedStation = activeStations[0];
              
              // Update the station with the voter ID and current timestamp
              const currentTime = Date.now();
              await setDoc(doc(db, "stations", selectedStation.id), {
                session: "active",
                lastActive: currentTime,
                currentVoterId: voterId
              }, { merge: true });
              
              // Update voter's hasVoted status
              await setDoc(doc(db, "Voter detials", voterId), {
                hasVoted: true,
                assignedStation: selectedStation.id
              }, { merge: true });
              
              document.getElementById("upload-status").innerHTML += `
                <div class="alert alert-success mt-3">
                  <strong>Station Assigned!</strong><br>
                  You have been assigned to <strong>${selectedStation.id}</strong>.<br>
                  Please proceed to that station to cast your vote.
                </div>
              `;
            } catch (error) {
              console.error('Error assigning station:', error);
              document.getElementById("upload-status").innerHTML += `
                <div class="alert alert-danger mt-3">
                  <strong>Error!</strong> Failed to assign station. Please try again.<br>
                  <small>Technical details: ${error.message}</small>
                </div>
              `;
            }
          });
        } else {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">
              <strong>Verification Failed!</strong><br>
              Fingerprint does not match the stored record.<br>
              <div class="mt-2">
                <strong>Debug Information:</strong><br>
                Generated Hash: <code>${hashHex}</code><br>
                Stored Hash: <code>${storedHash}</code><br>
                Status: Hashes do not match
              </div>
            </div>
          `;
          localStorage.setItem("fingerprint_verified", "false");
        }
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">
            Error processing fingerprint. Please try again.<br>
            <small>Technical details: ${err.message}</small>
          </div>
        `;
      }
    });
  </script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
