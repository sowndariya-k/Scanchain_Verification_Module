<!DOCTYPE html>
<html>
<head>
  <title>Fingerprint Verification</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h3>Fingerprint Verification</h3>
      </div>
      <div class="card-body">
        <p>Upload your fingerprint scan for two-step verification:</p>
        <input type="file" id="finger-upload" accept="image/*" class="form-control" />
        <div id="upload-status" class="mt-3"></div>
      </div>
    </div>
  </div>
  <!-- Firebase SDKs -->
  <script src="config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

    const firebaseConfig = config.firebaseConfig;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById("finger-upload").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // Retrieve the voter ID
      const voterId = localStorage.getItem("voter_id");
      if (!voterId) {
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">Error: Voter ID not found. Please login first.</div>
        `;
        return;
      }

      try {
        // Compute SHA-256 hash of the file
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashHex = Array.from(new Uint8Array(hashBuffer))
                          .map(b => b.toString(16).padStart(2, '0'))
                          .join('');
        
        // Debug: Log the hash to console
        console.log("Generated Hash:", hashHex);

        // Get the stored hash from Firestore
        const voterDoc = await getDoc(doc(db, "Voter detials", voterId));
        
        if (!voterDoc.exists()) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">Error: Voter record not found in database.</div>
          `;
          return;
        }

        const storedHash = voterDoc.data().hash;
        
        // Debug: Log the stored hash to console
        console.log("Stored Hash:", storedHash);
        
        if (!storedHash) {
          // If no hash is stored, store the new hash
          await setDoc(doc(db, "Voter detials", voterId), {
            hash: hashHex
          }, { merge: true });
          
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-success">
              <strong>Success!</strong> Fingerprint registered successfully.<br>
              <div class="mt-2">
                <strong>Debug Information:</strong><br>
                Generated Hash: <code>${hashHex}</code><br>
                Status: New hash stored in database
              </div>
            </div>
          `;
        } else {
          // Compare the hashes
          if (hashHex === storedHash) {
            document.getElementById("upload-status").innerHTML = `
              <div class="alert alert-success">
                <strong>Verification Successful!</strong><br>
                Fingerprint matches the stored record.<br>
                <div class="mt-2">
                  <strong>Debug Information:</strong><br>
                  Generated Hash: <code>${hashHex}</code><br>
                  Stored Hash: <code>${storedHash}</code><br>
                  Status: Hashes match
                </div>
              </div>
            `;
            // Store verification status in localStorage
            localStorage.setItem("fingerprint_verified", "true");
          } else {
            document.getElementById("upload-status").innerHTML = `
              <div class="alert alert-danger">
                <strong>Verification Failed!</strong><br>
                Fingerprint does not match the stored record.<br>
                <div class="mt-2">
                  <strong>Debug Information:</strong><br>
                  Generated Hash: <code>${hashHex}</code><br>
                  Stored Hash: <code>${storedHash}</code><br>
                  Status: Hashes do not match
                </div>
              </div>
            `;
            localStorage.setItem("fingerprint_verified", "false");
          }
        }
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">
            Error processing fingerprint. Please try again.<br>
            <small>Technical details: ${err.message}</small>
          </div>
        `;
      }
    });
  </script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
