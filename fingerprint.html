<!DOCTYPE html>
<html>
<head>
  <title>Fingerprint Verification</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h3>Fingerprint Verification</h3>
      </div>
      <div class="card-body">
        <p>Upload your fingerprint scan for two-step verification:</p>
        <input type="file" id="finger-upload" accept="image/*" class="form-control" />
        <div id="upload-status" class="mt-3"></div>
      </div>
    </div>
  </div>
  <!-- Environment variables -->
  <script src="env-vars.js"></script>
  <script src="env.js"></script>
  <!-- Firebase SDKs -->
  <script src="config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

    // Check if we're in a production environment (Netlify)
    let firebaseConfig;
    
    // Try to get config from environment variables first (for Netlify)
    if (window.location.hostname.includes('netlify.app')) {
      console.log("Running on Netlify, checking for environment variables");
      firebaseConfig = {
        apiKey: process.env.FIREBASE_API_KEY || "AIzaSyDuKns6v5EOUDL-aZXMA2i6223aquQzo1E",
        authDomain: process.env.FIREBASE_AUTH_DOMAIN || "voter-card-scanner.firebaseapp.com",
        projectId: process.env.FIREBASE_PROJECT_ID || "voter-card-scanner",
        storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "voter-card-scanner.appspot.com",
        messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "665299220821",
        appId: process.env.FIREBASE_APP_ID || "1:665299220821:web:f8025478a24f5375c697dc",
        measurementId: process.env.FIREBASE_MEASUREMENT_ID || "G-G88F77H8VR",
        databaseURL: "https://voter-card-scanner-default-rtdb.asia-southeast1.firebasedatabase.app"
      };
    } else {
      // Use the config.js file for local development
      firebaseConfig = config.firebaseConfig;
      // Ensure databaseURL is set
      if (!firebaseConfig.databaseURL) {
        firebaseConfig.databaseURL = "https://voter-card-scanner-default-rtdb.asia-southeast1.firebasedatabase.app";
      }
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    // Check if voter ID exists in localStorage
    const voterId = localStorage.getItem("voter_id");

    document.getElementById("finger-upload").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) {
        return;
      }

      // Retrieve the voter ID
      const voterId = localStorage.getItem("voter_id");
      if (!voterId) {
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">Error: Voter ID not found. Please login first.</div>
        `;
        return;
      }

      try {
        // Compute SHA-256 hash of the file
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashHex = Array.from(new Uint8Array(hashBuffer))
                          .map(b => b.toString(16).padStart(2, '0'))
                          .join('');

        // Get the stored hash from Firestore
        const voterDoc = await getDoc(doc(db, "Voter detials", voterId));
        
        if (!voterDoc.exists()) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">Error: Voter record not found in database.</div>
          `;
          return;
        }

        const voterData = voterDoc.data();
        const storedHash = voterData.hash;
        
        if (!storedHash) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">
              <strong>Error!</strong> No fingerprint record found. Please register your fingerprint first.<br>
              <button onclick="window.location.href='index.html'" class="btn btn-primary mt-3">Go Back</button>
            </div>
          `;
          return;
        }

        // Compare the hashes
        if (hashHex === storedHash) {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-success">
              <strong>Verification Successful!</strong><br>
              Fingerprint matches the stored record.<br>
              <button id="assignStationBtn" class="btn btn-primary mt-3">Assign to Station</button>
            </div>
          `;
          // Store verification status in localStorage
          localStorage.setItem("fingerprint_verified", "true");

          // Add click handler for the Assign Station button
          document.getElementById("assignStationBtn").addEventListener("click", assignToStation);
        } else {
          document.getElementById("upload-status").innerHTML = `
            <div class="alert alert-danger">
              <strong>Verification Failed!</strong><br>
              Fingerprint does not match the stored record.
            </div>
          `;
          localStorage.setItem("fingerprint_verified", "false");
        }
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("upload-status").innerHTML = `
          <div class="alert alert-danger">
            Error processing fingerprint. Please try again.
          </div>
        `;
      }
    });

    async function assignToStation() {
      const voterId = localStorage.getItem("voter_id");
      const assignBtn = document.getElementById("assignStationBtn");
      
      try {
        // Disable the button to prevent multiple clicks
        assignBtn.disabled = true;
        assignBtn.textContent = "Processing...";

        // Get all stations from Realtime Database
        const stationsRef = ref(rtdb, "stations");
        const stationsSnapshot = await get(stationsRef);

        if (!stationsSnapshot.exists()) {
          document.getElementById("upload-status").innerHTML += `
            <div class="alert alert-warning mt-3">
              <strong>No Stations Found!</strong><br>
              Please contact an administrator.
            </div>
          `;
          // Re-enable the button with retry option
          assignBtn.disabled = false;
          assignBtn.textContent = "Retry Assign to Station";
          return;
        }

        const stationsData = stationsSnapshot.val();

        // Find active stations
        const activeStations = Object.entries(stationsData)
          .filter(([_, data]) => data.session === "active")
          .map(([id, data]) => ({
            id,
            lastActive: data.lastActive || 0,
            currentVoterIds: data.currentVoterIds || []
          }));

        if (activeStations.length === 0) {
          document.getElementById("upload-status").innerHTML += `
            <div class="alert alert-warning mt-3">
              <strong>No Active Stations Available!</strong><br>
              <button id="retryBtn" class="btn btn-warning mt-2">Retry</button>
            </div>
          `;
          
          // Add retry functionality
          document.getElementById("retryBtn").addEventListener("click", () => {
            document.querySelector(".alert-warning").remove();
            assignBtn.disabled = false;
            assignBtn.textContent = "Assign to Station";
          });
          return;
        }

        // Sort by lastActive timestamp
        activeStations.sort((a, b) => a.lastActive - b.lastActive);
        const selectedStation = activeStations[0];
        const currentTime = Date.now();

        // Update station with new voter ID
        const updatedVoterList = [...selectedStation.currentVoterIds, voterId];
        await set(ref(rtdb, `stations/${selectedStation.id}`), {
          session: "active",
          lastActive: currentTime,
          currentVoterIds: updatedVoterList
        });

        // Get voter data again to ensure we have the latest
        const voterDoc = await getDoc(doc(db, "Voter detials", voterId));
        const voterData = voterDoc.data();

        // Update Firestore with verification status
        await setDoc(doc(db, "Voter detials", voterId), {
          ...voterData,
          hasVerified: true,
          verifiedAt: currentTime
        });

        document.getElementById("upload-status").innerHTML += `
          <div class="alert alert-success mt-3">
            <strong>Station Assigned Successfully!</strong><br>
            You have been assigned to <strong>${selectedStation.id}</strong>.
            <div class="mt-3">
              <button onclick="window.location.href='index.html'" class="btn btn-primary">Back to Home</button>
            </div>
          </div>
        `;

        // Keep the button disabled after successful assignment
        assignBtn.disabled = true;
        assignBtn.textContent = "Assigned to Station";
      } catch (error) {
        console.error("Assignment error:", error);
        document.getElementById("upload-status").innerHTML += `
          <div class="alert alert-danger mt-3">
            Error assigning to station. Please try again.
          </div>
        `;
        // Re-enable the button for retry
        assignBtn.disabled = false;
        assignBtn.textContent = "Retry Assign to Station";
      }
    }
  </script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>