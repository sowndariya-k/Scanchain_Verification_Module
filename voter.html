<!DOCTYPE html>
<html lang="en">
<head>
  <title>Voter Details</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3>Voter Details</h3>
      </div>
      <div class="card-body" id="voter-details">
        Loading voter details...
      </div>
    </div>
  </div>

  <!-- Environment variables -->

  <!-- Firebase and Firestore SDK -->
  <script src="config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

    // Check if we're in a production environment (Netlify)
    let firebaseConfig;
    
    // Try to get config from environment variables first (for Netlify)
    if (window.location.hostname.includes('netlify.app')) {
      console.log("Running on Netlify, checking for environment variables");
      firebaseConfig = {
        apiKey: process.env.FIREBASE_API_KEY || "AIzaSyDuKns6v5EOUDL-aZXMA2i6223aquQzo1E",
        authDomain: process.env.FIREBASE_AUTH_DOMAIN || "voter-card-scanner.firebaseapp.com",
        projectId: process.env.FIREBASE_PROJECT_ID || "voter-card-scanner",
        storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "voter-card-scanner.appspot.com",
        messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "665299220821",
        appId: process.env.FIREBASE_APP_ID || "1:665299220821:web:f8025478a24f5375c697dc",
        measurementId: process.env.FIREBASE_MEASUREMENT_ID || "G-G88F77H8VR"
      };
    } else {
      // Use the config.js file for local development
      firebaseConfig = config.firebaseConfig;
    }

    console.log("Firebase config loaded:", firebaseConfig);

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const voter_id = localStorage.getItem("voter_id");
    if (!voter_id) {
      alert("No voter ID found. Redirecting to login page.");
      window.location.href = "index.html";
    }

    async function fetchVoterDetails(voter_id) {
      console.log("Fetching voter details for ID:", voter_id);
      try {
        const response = await fetch(`/api/voter-details?voter_id=${voter_id}`);
        if (!response.ok) {
          const error = await response.text();
          console.error('Error fetching voter details:', error);
          document.getElementById("voter-details").innerHTML = `<div class='alert alert-danger'>Error fetching voter details: ${error}</div>`;
          return;
        }
        const data = await response.json();
        console.log("Voter data retrieved:", data);
        displayVoterDetails(data);
        hashData(data);
      } catch (error) {
        console.error("Error fetching voter details:", error);
        document.getElementById("voter-details").innerHTML = `<div class='alert alert-danger'>Network error fetching voter details. Please try again.</div>`;
      }
    }

    function displayVoterDetails(data) {
      const hasVoted = data.hasVoted;
      if(hasVoted){
        const html = `
        <p><strong>EPIC No:</strong> ${data.voter_id}</p>
        <p><strong>Name:</strong> ${data.Name}</p>
        <p><strong>Age:</strong> ${data.Age}</p>
        <p><strong>Gender:</strong> ${data.Gender}</p>
        <p><strong>Parent/Spouse:</strong> ${data["Parent/Spouse"]}</p>
        <p><strong>State:</strong> ${data.State}</p>
        <p><strong>District:</strong> ${data.District}</p>
        <p><strong>Assembly Constituency:</strong> ${data["Assembly Constituency"]}</p>
        <p><strong>Parliamentary Constituency:</strong> ${data["Parliamentary Constituency"]}</p>
        <p><strong>Part Name:</strong> ${data["Part Name"]}</p>
        <p><strong>Part No:</strong> ${data["Part No"]}</p>
        <p><strong>Serial No:</strong> ${data["Serial No"]}</p>
        <div class="alert alert-warning">
              <strong>Already Voted!</strong><br>
              The voter have already casted their vote.<br>
              <button onclick="window.location.href='index.html'" class="btn btn-primary mt-3">Go Back</button>
            </div>
      `;
        document.getElementById("voter-details").innerHTML = html;

      }else{
        const html = `
        <p><strong>EPIC No:</strong> ${data.voter_id}</p>
        <p><strong>Name:</strong> ${data.Name}</p>
        <p><strong>Age:</strong> ${data.Age}</p>
        <p><strong>Gender:</strong> ${data.Gender}</p>
        <p><strong>Parent/Spouse:</strong> ${data["Parent/Spouse"]}</p>
        <p><strong>State:</strong> ${data.State}</p>
        <p><strong>District:</strong> ${data.District}</p>
        <p><strong>Assembly Constituency:</strong> ${data["Assembly Constituency"]}</p>
        <p><strong>Parliamentary Constituency:</strong> ${data["Parliamentary Constituency"]}</p>
        <p><strong>Part Name:</strong> ${data["Part Name"]}</p>
        <p><strong>Part No:</strong> ${data["Part No"]}</p>
        <p><strong>Serial No:</strong> ${data["Serial No"]}</p>
        <div class="mt-4 text-center">
          <button id="confirm-btn" class="btn btn-success btn-lg">Confirm</button>
        </div>
      `;
      document.getElementById("voter-details").innerHTML = html;
      // Add event listener to the confirm button
      document.getElementById("confirm-btn").addEventListener("click", () => {
            window.location.href = "fingerprint.html";
          });
      }
    }

    async function hashData(data) {
      const encoder = new TextEncoder();
      const encoded = encoder.encode(JSON.stringify(data));
      const hashBuffer = await crypto.subtle.digest('SHA-256', encoded);
      const hashHex = Array.from(new Uint8Array(hashBuffer))
                          .map(b => b.toString(16).padStart(2, '0'))
                          .join('');
      console.log("Hashed Voter Data:", hashHex);
      localStorage.setItem("voter_data_hash", hashHex);
      // Remove the automatic redirect
    }

    fetchVoterDetails(voter_id);
  </script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
